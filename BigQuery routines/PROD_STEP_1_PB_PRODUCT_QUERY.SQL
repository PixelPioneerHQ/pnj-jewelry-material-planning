CREATE OR REPLACE PROCEDURE `pnj-material-planing.TESTING_MRP.PROD_STEP_1_PB_PRODUCT_QUERY`()
BEGIN
  CREATE OR REPLACE TABLE `pnj-material-planing.TESTING_MRP.STEP_1_PB_PRODUCT_QUERY` AS 

WITH A AS (
  SELECT B.BASIC_NEW_2
      ,B.BASIC_NEW_CODE
      ,B.PFSAP
      ,B.PRODUCT_FAMILY
      ,B.X_PLANT_MATL_STATUS
      ,B.L4_NEW_NAME
      ,A.* 
      ,C.D_QUALITY
      ,C.SIZE
      ,E.MASTER_NEW
      ,B.PURITY_OF_GOLD
      ,ROW_NUMBER() OVER(PARTITION BY B.BASIC_NEW_CODE, B.PFSAP, A.PRODUCT_CODE ORDER BY RIGHT(A.COMP_MAT_CODE, 6) DESC) COMP_LEVEL
  FROM `pnj-material-planing.INPUT_MATERIAL_PLANING.W_MP_BOM_D` A
  LEFT JOIN `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` B ON A.PRODUCT_CODE = B.MATERIAL
  LEFT JOIN `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` C ON A.COMP_MAT_CODE = C.MATERIAL
  LEFT JOIN (SELECT DISTINCT LEFT13 FROM `pnj-material-planing.INPUT_MATERIAL_PLANING.MP_BOM_ALERT`) D ON LEFT(A.PRODUCT_CODE, 13) = D.LEFT13
  LEFT JOIN `pnj-material-planing.INPUT_MATERIAL_PLANING.MP_MASTER_NEW` E ON LEFT(A.PRODUCT_CODE, 13) = E.MASTER_NEW
  WHERE 1 = 1
  AND (
    (UPPER(B.X_PLANT_MATL_STATUS) IN ('08', 'I1')

    AND B.IS_SAMPLE NOT IN ('K', 'E')
    AND B.L4_NEW_NAME IN ('TRANG SỨC KIM CƯƠNG', 'TRANG SỨC VỎ', 'TRANG SỨC ĐÁ MÀU', 'TRANG SỨC NGỌC TRAI')    
    AND C.L4_NEW_NAME IN ('KIM CƯƠNG SẢN XUẤT', 'KIM CƯƠNG RỜI', 'ĐÁ MÀU', 'NGỌC TRAI')
    AND B.BASIC_NEW_CODE NOT LIKE '%Cao%')
    OR E.MASTER_NEW IS NOT NULL
  )
  AND A.COMP_MAT_TYPE_CODE = 'ZT02'
  AND D.LEFT13 IS NULL
  AND UPPER(B.X_PLANT_MATL_STATUS) NOT IN ('06', '07', 'I2')
  AND LEFT(A.PRODUCT_CODE,7) = LEFT(B.BASIC_NEW_2,7)
)

# RANKING NI
, C AS (
  SELECT
     BASIC_NEW_2
    ,PRODUCT_CODE 
    ,ROW_NUMBER() OVER (PARTITION BY BASIC_NEW_2, PFSAP, LEFT(PRODUCT_CODE, 13) ORDER BY REPLACE(X_PLANT_MATL_STATUS, '0', 'ZZ') DESC, PRODUCT_CODE DESC) RANK_NI
    ,COUNT_NI
  FROM (
    SELECT DISTINCT 
       A.BASIC_NEW_2
      ,A.PFSAP
      ,A.PRODUCT_CODE
      ,A.X_PLANT_MATL_STATUS
      ,A.VALID_FROM_DT
      ,COUNT(*) OVER (PARTITION BY BASIC_NEW_2, PFSAP, LEFT(PRODUCT_CODE, 13)) COUNT_NI
    FROM A
  )
)

# BOM BASIC
, D AS (
  SELECT A.*   
      ,D.Giam
      ,D.Tang   
  FROM A
  LEFT JOIN C ON A.BASIC_NEW_2 = C.BASIC_NEW_2 AND A.PRODUCT_CODE = C.PRODUCT_CODE
  LEFT JOIN `pnj-material-planing.INPUT_MATERIAL_PLANING.MP_BOM_TOLERANCE_CHECK` D ON A.PRODUCT_CODE = D.MATERIAL AND A.COMP_MAT_CODE = D.COMP
  WHERE C.BASIC_NEW_2 = LEFT(C.PRODUCT_CODE, 13)
  AND RANK_NI = 1
)

# PO KHACH  
, E AS (
  SELECT DISTINCT PROD_NUM
  FROM `pnj-material-planing.INPUT_MATERIAL_PLANING.W_MP_PO_LINE_F`
  WHERE PURCH_ORDER_GRP IN ('111', '640')
  AND LEFT(PURCH_ORDER_NUM, 2) IN ('41', '46')
  AND DELETION_IND = ''
  AND INCOMPLETE_FLG != 'X'
  AND COMPANY_CODE = '1000'
)

# BOM VUOT DUNG SAI + HANG KHACH
, F AS (
  SELECT DISTINCT PRODUCT_CODE
  FROM (
    SELECT A.*
        ,D.COMP_MAT_CODE
        ,D.COMP_LEVEL
        ,D.SIZE AS SIZE_BASIC
        ,ABS(CAST(A.SIZE AS BIGNUMERIC) - CAST(D.SIZE AS BIGNUMERIC)) AS GAP_SIZE
        ,IFNULL(D.Giam, 0.1) delta
    FROM A
    LEFT JOIN C ON A.BASIC_NEW_2 = C.BASIC_NEW_2 AND A.PRODUCT_CODE = C.PRODUCT_CODE
    LEFT JOIN D ON A.BASIC_NEW_2 = D.BASIC_NEW_2 AND A.PFSAP = D.PFSAP AND A.COMP_LEVEL = D.COMP_LEVEL
    WHERE C.RANK_NI = 1
  ) 
  WHERE 
  (GAP_SIZE > delta AND L4_NEW_NAME IN ('TRANG SỨC KIM CƯƠNG', 'TRANG SỨC VỎ'))
  OR (D_QUALITY IN ('VS1','A') AND L4_NEW_NAME IN ('TRANG SỨC KIM CƯƠNG', 'TRANG SỨC ĐÁ MÀU', 'TRANG SỨC NGỌC TRAI'))
)

# PRODUCT_CODE PURITY_OF_GOLD = BASIC_NEW_2
, P AS (
  SELECT DISTINCT A.PRODUCT_CODE
  FROM A
  LEFT JOIN D ON D.BASIC_NEW_2 = A.BASIC_NEW_2
    -- (
    --   SELECT A.*    
    --   FROM A
    --   LEFT JOIN C ON A.BASIC_NEW_2 = C.BASIC_NEW_2 AND A.PRODUCT_CODE = C.PRODUCT_CODE
    --   WHERE C.BASIC_NEW_2 = LEFT(C.PRODUCT_CODE, 13)
    -- ) BOM_BASIC ON BOM_BASIC.BASIC_NEW_2 = A.BASIC_NEW_2 

  WHERE A.PURITY_OF_GOLD  = D.PURITY_OF_GOLD
)

, BOM AS (
  SELECT A.*
    ,IFNULL(SALE.INVOICED_QTY, 0) AS SALE_180_DAY
    ,IFNULL(SALE_MONTH_90D.INVOICED_QTY / NULLIF(SALE.INVOICED_QTY, 0), 0) TT_PERCENT
    ,COUNT_NI
  FROM A
  LEFT JOIN C ON A.BASIC_NEW_2 = C.BASIC_NEW_2 AND A.PRODUCT_CODE = C.PRODUCT_CODE
  LEFT JOIN F ON  A.PRODUCT_CODE = F.PRODUCT_CODE
  LEFT JOIN P ON A.PRODUCT_CODE = P.PRODUCT_CODE
  LEFT JOIN (
    SELECT 
      LEFT(MATERIAL, 13) MATERIAL
      ,SUM(INVOICED_QTY) INVOICED_QTY
    FROM `pnj-data-warehouse.GENERAL.W_SALE_F`
    WHERE INVOICE_DATE >= DATE_ADD(CURRENT_DATE('UTC+7'), INTERVAL -180 DAY)
    GROUP BY 1
  ) SALE ON LEFT(A.PRODUCT_CODE, 13) = SALE.MATERIAL
  LEFT JOIN (
    SELECT 
      LEFT(MATERIAL, 13) MATERIAL
      ,SUM(INVOICED_QTY) INVOICED_QTY
    FROM `pnj-data-warehouse.GENERAL.W_SALE_F`
    WHERE INVOICE_DATE >= DATE_ADD(CURRENT_DATE('UTC+7'), INTERVAL -90 DAY)
    GROUP BY 1
  ) SALE_MONTH_90D ON LEFT(A.PRODUCT_CODE, 13) = SALE_MONTH_90D.MATERIAL
  WHERE 1 = 1
  AND (F.PRODUCT_CODE IS NULL OR A.MASTER_NEW IS NOT NULL)
  AND C.RANK_NI = 1
  AND P.PRODUCT_CODE IS NOT NULL
)

, STOCK_AVAILABLE_ZT02 AS (
  SELECT 
    Material AS MATERIAL
    ,Inventory AS TOTAL_STOCK
  FROM `pnj-material-planing.INPUT_MATERIAL_PLANING.STOCK_AVAILABLE_TEST`
)

# NHU CAU
, NHUCAU AS (
  SELECT *
  FROM (
    SELECT B.BASIC_NEW_2
        ,M.PFSAP
        ,B.PRODUCT_FAMILY
        ,M.BASIC_NEW_CODE
        ,SUM(A.SL) AS D0
    FROM `pnj-material-planing.INPUT_MATERIAL_PLANING.D0_TEST` A
    LEFT JOIN  (
      SELECT DISTINCT BASIC_NEW_2 as BASIC_NEW_2
          ,PRODUCT_FAMILY as PRODUCT_FAMILY
      FROM `pnj-da-plc.SHARING_DA_PLC.W_DMHHKN_DU_KIEN_F`
      WHERE CLASSIFICATION_DMKN IN ('DMKN-Bổ sung', 'DMKN-Giữ lại')
    ) B USING (BASIC_NEW_2)
    -- LEFT JOIN (
    --   SELECT DISTINCT BASIC_NEW_2
    --       ,PRODUCT_FAMILY
    --   FROM `pnj-data-warehouse.GENERAL.W_DMHHKN_F`
    --   WHERE MONTH = (
    --     SELECT MAX(MONTH)
    --     FROM `pnj-data-warehouse.GENERAL.W_DMHHKN_F`
    --   ) AND CLASSIFICATION_DMKN IN ('DMKN-Bổ sung', 'DMKN-Giữ lại')
    -- ) B USING (BASIC_NEW_2)
    LEFT JOIN (
      SELECT DISTINCT BASIC_NEW_2
          ,PFSAP
          ,PRODUCT_FAMILY
          ,BASIC_NEW_CODE
      FROM `pnj-data-warehouse.GENERAL.W_MASTERDATA_D`
    ) M ON CONCAT(M.PRODUCT_FAMILY, M.BASIC_NEW_2) = CONCAT(B.PRODUCT_FAMILY, B.BASIC_NEW_2)
    GROUP BY 1, 2, 3, 4
  ) A
)

,FILTEREDBOM AS (
    SELECT *
    FROM BOM
    WHERE COMP_MAT_TYPE_CODE = 'ZT02'
),
AGGREGATEDDATA AS (
    SELECT 
        BASIC_NEW_CODE,
        PFSAP,
        PRODUCT_CODE,
        PRIORITY_BOM,
        SALE_180_DAY,
        TT_PERCENT,
        COUNT_NI,
        ARRAY_AGG(COMP_MAT_CODE) AS ARRAY_AGG
    FROM FILTEREDBOM
    GROUP BY 
        BASIC_NEW_CODE,
        PFSAP,
        PRODUCT_CODE,
        SALE_180_DAY,
        TT_PERCENT,
        PRIORITY_BOM,
        COUNT_NI
),
RANKEDDATA AS (
    SELECT 
        BASIC_NEW_CODE,
        PFSAP,
        PRODUCT_CODE,
        SALE_180_DAY,
        PRIORITY_BOM,
        TT_PERCENT,
        COUNT_NI,
        ARRAY_TO_STRING(ARRAY_AGG, '_') AS CONCAT_COMP,
        CASE 
            WHEN LEFT(BASIC_NEW_CODE, 13) = LEFT(PRODUCT_CODE, 13) THEN 0 
            ELSE 1 
        END AS BASIC_RANK,
    FROM AGGREGATEDDATA
),
RANKBOM AS (
  SELECT *,
        ROW_NUMBER() OVER (
        PARTITION BY BASIC_NEW_CODE, CONCAT_COMP 
        ORDER BY BASIC_RANK ASC, SALE_180_DAY DESC, COUNT_NI DESC, TT_PERCENT DESC
    ) AS RANK_BOMDA
  FROM RANKEDDATA
),
SELECTEDBOM AS (
    SELECT 
        BASIC_NEW_CODE,
        PFSAP,
        PRODUCT_CODE
    FROM RANKBOM
    WHERE RANK_BOMDA = 1
)
,BOM_F AS (
SELECT BOM.*
FROM BOM
INNER JOIN SELECTEDBOM B 
ON BOM.BASIC_NEW_CODE = B.BASIC_NEW_CODE 
AND BOM.PRODUCT_CODE = B.PRODUCT_CODE
)

  SELECT 
    BASIC_NEW_2
    ,PFSAP
    ,PRODUCT_FAMILY
    ,BASIC_NEW_CODE
    ,D0
    ,PRODUCT_CODE_LEFT_13
    ,PRODUCT_NAME
    ,PRODUCT_TYPE_CODE
    ,SALE_180_DAY
    ,BASE_UOM
    ,BASE_QTY
    ,COMP_MAT_CODE
    ,COMP_MAT_NAME
    ,COMP_MAT_TYPE_CODE
    ,COMP_MAT_TYPE_NAME
    ,COMPONENT_UOM
    ,COMPONENT_QTY
    ,D0_ZT02
    ,STOCK_AVAILABLE
  FROM(
    SELECT 
      NHUCAU.BASIC_NEW_2
      ,NHUCAU.PFSAP
      ,NHUCAU.PRODUCT_FAMILY
      ,NHUCAU.BASIC_NEW_CODE
      ,LEFT(BOM_F.PRODUCT_CODE,13) PRODUCT_CODE_LEFT_13
      ,D0
      ,BOM_F.PRODUCT_NAME
      ,BOM_F.PRODUCT_TYPE_CODE
      ,IFNULL(BOM_F.SALE_180_DAY,0) SALE_180_DAY
      ,BOM_F.BASE_UOM
      ,BOM_F.BASE_QTY
      ,BOM_F.COMP_MAT_CODE
      ,BOM_F.COMP_MAT_NAME
      ,BOM_F.COMP_MAT_TYPE_CODE
      ,BOM_F.COMP_MAT_TYPE_NAME
      ,BOM_F.COMPONENT_UOM
      ,BOM_F.COMPONENT_QTY
      ,NHUCAU.D0/BASE_QTY*BOM_F.COMPONENT_QTY AS D0_ZT02
      ,IFNULL(STOCK_AVAILABLE_ZT02.TOTAL_STOCK,0) AS STOCK_AVAILABLE
    FROM NHUCAU
    LEFT JOIN BOM_F ON BOM_F.BASIC_NEW_CODE = NHUCAU.BASIC_NEW_CODE
                  AND BOM_F.BASIC_NEW_2 = NHUCAU.BASIC_NEW_2
                  AND BOM_F.PFSAP = NHUCAU.PFSAP
                  AND BOM_F.PRODUCT_FAMILY = NHUCAU.PRODUCT_FAMILY
    LEFT JOIN STOCK_AVAILABLE_ZT02 ON BOM_F.COMP_MAT_CODE = STOCK_AVAILABLE_ZT02.MATERIAL
    WHERE BOM_F.COMP_MAT_TYPE_CODE = 'ZT02'
  )A;
END;