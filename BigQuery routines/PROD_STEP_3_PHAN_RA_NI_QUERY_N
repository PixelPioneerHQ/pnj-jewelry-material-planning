CREATE OR REPLACE PROCEDURE `pnj-material-planing.TESTING_MRP.PROD_STEP_3_PHAN_RA_NI_QUERY_N`()
BEGIN
  CREATE OR REPLACE TABLE `pnj-material-planing.TESTING_MRP.STEP_3_PHAN_RA_NI_QUERY_N` AS 

WITH SALES AS (
  SELECT A.MATERIAL
        ,SUM(INVOICED_QTY) INVOICED_QTY
  FROM `pnj-data-warehouse.GENERAL.W_SALE_F` A
  LEFT JOIN `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` B ON A.MATERIAL = B.MATERIAL
  WHERE INVOICE_DATE >= DATE_ADD(CURRENT_DATE('UTC+7'),INTERVAL - 6 MONTH) 
              AND UPPER(X_PLANT_MATL_STATUS) IN ('08','I1')
              AND B.IS_SAMPLE NOT IN ('K','E')
              AND LEFT(A.PFSAP,2) IN ('PG','PP','PS')
  GROUP BY 1)

, NI_BASIC AS 
(
  SELECT * 
    , IFNULL(INVOICED_QTY/NULLIF(SUM(INVOICED_QTY) OVER(PARTITION BY BASIC_NEW_2, PFSAP),0),0) AS TT_BASIC
  FROM 
    (SELECT *  
      FROM 
        (SELECT A.BASIC_NEW_2
          , A.PFSAP
          -- , A.PRODUCT_FAMILY
          , RIGHT(A.MATERIAL,3) AS KHUNG_NI_BASIC 
          -- , A.IS_MEN_JEWELRY
          , SUM(IFNULL(INVOICED_QTY,0)) AS INVOICED_QTY
        FROM `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` A
        LEFT JOIN SALES B ON A.MATERIAL = B.MATERIAL 
        WHERE UPPER(X_PLANT_MATL_STATUS) IN ('08')
              AND A.IS_SAMPLE NOT IN ('K','E')
              AND LEFT(A.PFSAP,2) IN ('PG','PP','PS')
        GROUP BY 1,2,3)
        )
  )

# INVENTORY ONHAND
, IOH AS 
(
  SELECT B.BASIC_NEW_2
    ,B.PFSAP
    -- ,B.PRODUCT_FAMILY
    ,RIGHT(A.MATERIAL,3) AS KHUNG_NI
    -- ,B.IS_MEN_JEWELRY
    ,SUM(TOTAL_STOCK - BLOCKED +TRANS_TFR) TOTAL_STOCK
  FROM `pnj-data-warehouse.RAW.W_SC_INV_CURRENT_M_F` A
  LEFT JOIN `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` B ON A.MATERIAL = B.MATERIAL
  LEFT JOIN (SELECT DISTINCT PLANT_CODE, PLANT_TYPE FROM `pnj-data-warehouse.RAW.W_PLANT_D`) C ON A.PLANT = C.PLANT_CODE
  INNER JOIN `pnj-data-warehouse.RAW_SERVER_UPLOAD.W_SLOC_D` D ON CONCAT(C.PLANT_TYPE,A.SLOC) = D.Code
  WHERE 1=1 
    AND PLANT <> '1099' 
    AND COMPANYCODE = '1000'
    AND DATA_DAY = (SELECT MAX(DATA_DAY) FROM `pnj-data-warehouse.RAW.W_SC_INV_CURRENT_M_F`)
  GROUP BY 1,2,3
  )

## INVENTORY TTBH 
, IOH_TTBH AS 
(
  SELECT B.BASIC_NEW_2
    ,B.PFSAP
    ,RIGHT(A.MATERIAL,3) AS KHUNG_NI
    -- ,B.IS_MEN_JEWELRY
    ,SUM(TOTAL_STOCK - BLOCKED +TRANS_TFR) TOTAL_STOCK
  FROM `pnj-data-warehouse.RAW.W_SC_INV_CURRENT_M_F` A
  LEFT JOIN `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` B ON A.MATERIAL = B.MATERIAL
  WHERE 
    DATA_DAY = (SELECT MAX(DATA_DAY)  FROM `pnj-data-warehouse.RAW.W_SC_INV_CURRENT_M_F` )
    AND COMPANYCODE = '1000'
    AND PLANT = '1099' 
    AND SLOC = '1104'
    AND RIGHT(BATCH,8) IN (SELECT DISTINCT CAST(BATCH_WID AS STRING) BATCH_WID 
                              FROM `pnj-data-warehouse.RAW.W_INVENTORY_TRX_F` 
                              WHERE PLANT_WID = 2376 
                                  AND SPECIAL_STOCK <> 'B' 
                                  AND BATCH_WID IS NOT NULL
                          )
    GROUP BY 1,2,3    
)

## PO INCOMING 
, PO_INC AS 
(
  SELECT BASIC_NEW_2
    ,PFSAP
    ,KHUNG_NI
    -- ,IS_MEN_JEWELRY
    ,SUM(PO_QTY) PO_QTY
  FROM
      (SELECT BASIC_NEW_2
          ,PFSAP
          ,RIGHT(MATERIAL,3) AS KHUNG_NI
          -- ,B.IS_MEN_JEWELRY
          ,CASE WHEN ORDER_QTY > GR_QTY THEN ORDER_QTY - GR_QTY ELSE 0 END PO_QTY
      FROM `pnj-material-planing.INPUT_MATERIAL_PLANING.W_MP_PO_LINE_F` A
      LEFT JOIN `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` B ON A.PROD_NUM = B.MATERIAL
      LEFT JOIN (SELECT DISTINCT DATEKEY, DATE FROM  `pnj-data-warehouse.GENERAL.W_DATE_D`) C ON A.DATE_KEY = C.DATEKEY
      WHERE A.DELIVERY_COMPLETED <> 'X' 
      AND A.PURCH_ORDER_GRP = '110'
      AND A.COMPANY_CODE = '1000'
      AND A.PURCH_ORDER_CAT = 'F'
      AND A.PURCH_ORDER_TYPE IN ('Z01','Z02','Z07')
      AND A.PROD_NUM IS NOT NULL
      AND B.BASIC_NEW_CODE IS NOT NULL
      AND C.DATE >= DATE_ADD(CURRENT_DATE('UTC+7'),INTERVAL -4 MONTH)

      UNION ALL

      SELECT 
        C.BASIC_NEW_2
        ,C.PFSAP
        ,RIGHT(B.PROD_NUM,3) KHUNG_NI
        -- ,C.IS_MEN_JEWELRY
        ,A.REQUESTED_QTY
      FROM `pnj-data-warehouse.GENERAL.W_VW_PURCHASE_REQUISITION_F` A
      LEFT JOIN `pnj-data-warehouse.RAW.W_PRODUCT_D` B ON A.PRODUCT_WID = B.ROW_WID
      LEFT JOIN `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` C ON B.PROD_NUM = C.MATERIAL
      LEFT JOIN (SELECT DISTINCT PURCH_RQSTN_NUM, PURCH_ORDER_NUM, PROD_NUM 
                  FROM `pnj-material-planing.INPUT_MATERIAL_PLANING.W_MP_PO_LINE_F` 
                  WHERE COMPANY_CODE = '1000'
                ) D ON A.PURCH_RQSTN_NUM = D.PURCH_RQSTN_NUM AND B.PROD_NUM = D.PROD_NUM
      WHERE 
        A.PURCH_GROUP = '110'
        AND A.DELETE_FLG = 'False'
        AND LEFT(SAFE_CAST(A.PURCH_RQSTN_NUM AS STRING),2) IN ('30','21')  
        AND A.REQUISITION_DATE >= DATE_ADD(CURRENT_DATE('UTC+7'),INTERVAL -1 MONTH)
        AND A.PURCH_ORDER_NUM = ''
        AND A.ORG_CODE = '1000'
        AND D.PROD_NUM IS NULL
      )
GROUP BY  1,2,3
)

## OUTPUT 
, OUTPUT AS 
(
  SELECT DISTINCT A.BASIC_NEW_2
    , A.PFSAP
    , A.D0
    , A.PRODUCT_CODE_LEFT_13
    -- , B.IS_MEN_JEWELRY
    , B.IS_NEW
    , A.PB_PRODUCT 
  FROM `pnj-material-planing.TESTING_MRP.STEP_2_MUAMOI_NVL_OUTPUT` A
  LEFT JOIN `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` B ON A.PRODUCT_CODE_LEFT_13 = LEFT(MATERIAL,13)
  WHERE A.PB_PRODUCT > 0


)
SELECT O.*,R.X_PLANT_MATL_STATUS
FROM 
(
  SELECT A.*
    -- ,IFNULL(CAST(NULLIF(SUM(INV_AVAILABLE) OVER(PARTITION BY A.BASIC_NEW_2,A.PFSAP,PRODUCT_CODE_LEFT_13),0) + IFNULL(PB_BASIC,0)	AS INTEGER),0)		INV_POSITION	
    ,CAST(COALESCE(SUM(INV_AVAILABLE) OVER(PARTITION BY A.BASIC_NEW_2,A.PFSAP,PRODUCT_CODE_LEFT_13),0) AS INTEGER) +IFNULL(PB_BASIC,0) INV_POSITION	
    ,CAST(IFNULL(AVG_SALES/NULLIF(SUM(AVG_SALES) OVER(PARTITION BY A.BASIC_NEW_2, A.PFSAP
                                                                            -- , A.IS_MEN_JEWELRY
                                                                            ),0),0)	AS FLOAT64)		TT_BASIC
    FROM 
      (
        SELECT DISTINCT A.BASIC_NEW_2
          , A.PFSAP
          , A.D0
          , A.PRODUCT_CODE_LEFT_13
          , C.MATERIAL
          , CASE WHEN IS_SAMPLE IN ('K', 'E') THEN CONCAT(C.X_PLANT_MATL_STATUS,'_', IS_SAMPLE) ELSE C.X_PLANT_MATL_STATUS END AS NOTE
          , A.PB_PRODUCT 
          -- , A.IS_MEN_JEWELRY
          , A.IS_NEW
          , B.KHUNG_NI_BASIC 
          ,ROUND(CAST(B.INVOICED_QTY/6 AS FLOAT64),2) ORG_SALES	 	
          ,ROUND(CAST( B.INVOICED_QTY/6	AS FLOAT64),2) AVG_SALES
          ,CAST(IFNULL(D.TOTAL_STOCK,0) + IFNULL(E.TOTAL_STOCK,0) + IFNULL(F.PO_QTY,0) AS INTEGER) INV_AVAILABLE
        FROM OUTPUT A
        LEFT JOIN NI_BASIC B ON A.BASIC_NEW_2 = B.BASIC_NEW_2 
                            AND A.PFSAP = B.PFSAP 
                            -- AND A.IS_MEN_JEWELRY = B.IS_MEN_JEWELRY
        LEFT JOIN 
          (SELECT * 
          FROM  `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` 
          INNER JOIN 
          (SELECT DISTINCT PRODUCT_CODE FROM `pnj-material-planing.INPUT_MATERIAL_PLANING.W_MP_BOM_D`) ON PRODUCT_CODE =MATERIAL)  
          C ON A.PRODUCT_CODE_LEFT_13 = LEFT(C.MATERIAL,13) AND RIGHT(C.MATERIAL,3) = B.KHUNG_NI_BASIC

          LEFT JOIN IOH D ON A.BASIC_NEW_2 = D.BASIC_NEW_2 
                          AND A.PFSAP = D.PFSAP 
                          AND B.KHUNG_NI_BASIC = D.KHUNG_NI 
                          -- AND A.IS_MEN_JEWELRY = D.IS_MEN_JEWELRY
          LEFT JOIN IOH_TTBH E ON A.BASIC_NEW_2 = E.BASIC_NEW_2 
                          AND A.PFSAP = E.PFSAP 
                          AND B.KHUNG_NI_BASIC = E.KHUNG_NI 
                          -- AND A.IS_MEN_JEWELRY = E.IS_MEN_JEWELRY
          LEFT JOIN PO_INC F ON A.BASIC_NEW_2 = F.BASIC_NEW_2 
                          AND A.PFSAP = F.PFSAP 
                          AND B.KHUNG_NI_BASIC = F.KHUNG_NI 
                          -- AND A.IS_MEN_JEWELRY = F.IS_MEN_JEWELRY
          WHERE A.PB_PRODUCT > 0 
              AND B.INVOICED_QTY > 0
              AND B.TT_BASIC > 0.05 
              -- AND C.MATERIAL IS NOT NULL
      ) A
LEFT JOIN (
        SELECT BASIC_NEW_2,PFSAP, SUM(NULLIF(PB_PRODUCT,0)) AS PB_BASIC
        FROM(
            SELECT DISTINCT BASIC_NEW_2,PFSAP, PRODUCT_CODE_LEFT_13,PB_PRODUCT 
            FROM `pnj-material-planing.TESTING_MRP.STEP_2_MUAMOI_NVL_OUTPUT` )
            GROUP BY 1,2
        ) B ON A.BASIC_NEW_2 = B.BASIC_NEW_2 AND A.PFSAP = B.PFSAP
) O
LEFT JOIN `pnj-data-warehouse.GENERAL.W_MASTERDATA_D` R ON O.MATERIAL = R.MATERIAL
WHERE INV_POSITION > 0
-- O.BASIC_NEW_2 = 'GNDD00H000407'

;
END;